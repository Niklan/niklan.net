parameters:
  external_content.blog.working_dir: null

services:
  _defaults:
    autowire: true

  niklan.event_subscriber:
    class: Drupal\niklan\EventSubscriber\RouteSubscriber
    tags:
      - { name: event_subscriber }

  niklan.repository.about_settings:
    class: Drupal\niklan\Repository\AboutSettingsRepository
    arguments: ['@keyvalue']

  niklan.helper.tag_statistics:
    class: Drupal\niklan\Helper\TagStatistics
    arguments: ['@database']

  niklan.event_subscriber.term_page_build:
    class: Drupal\niklan\EventSubscriber\TermPageBuildSubscriber
    arguments: [ '@class_resolver' ]
    tags:
      - { name: event_subscriber }

  niklan.search.search_api:
    abstract: true
    arguments:
      - '@search_api.query_helper'
      - '@entity_type.manager'

  niklan.search.global:
    parent: niklan.search.search_api
    class: Drupal\niklan\Search\GlobalSearch

  niklan.builder.content_editing_toolbar_links:
    class: Drupal\niklan\Builder\ContentEditingToolbarLinksBuilder
    arguments: ['@plugin.manager.menu.local_task', '@current_route_match']

  niklan.process.terminal:
    class: Drupal\niklan\Process\Terminal
    arguments: ['@file_system']

  niklan.process.git:
    class: Drupal\niklan\Process\Git
    arguments: ['@niklan.process.terminal']

  keyvalue.niklan.content_sync_settings:
    class: Drupal\Core\KeyValueStore\KeyValueStoreInterface
    factory: ['@keyvalue', 'get']
    arguments: ['niklan.content_sync_settings']

  niklan.repository.content_sync_settings:
    class: Drupal\niklan\Repository\ContentSyncSettingsRepository
    arguments:
      - '@keyvalue.niklan.content_sync_settings'

  Drupal\niklan\EventSubscriber\FileFoundEventSubscriber:
    tags:
      - { name: event_subscriber }

  Drupal\niklan\Asset\ContentAssetManager:
    arguments:
      $fileUsage: '@file.usage'
  Drupal\niklan\Sync\BlogSyncManager:
    arguments:
      $environment: '@external_content.environment.blog'
  Drupal\niklan\Builder\BlogMarkdownEnvironmentBuilder: {}
  Drupal\niklan\Converter\BlogMarkdownConverter: {}

  Drupal\niklan\Identifier\ExternalContent\FrontMatterIdentifier: {}
  Drupal\niklan\Serializer\ExternalContent\DrupalMediaSerializer: {}
  Drupal\niklan\Serializer\ExternalContent\NoteSerializer: {}
  Drupal\niklan\Builder\ExternalContent\RenderArray\DrupalMedia: {}
  Drupal\niklan\Builder\ExternalContent\RenderArray\CodeBlock: {}
  Drupal\niklan\Builder\ExternalContent\RenderArray\Note: {}
  Drupal\niklan\Builder\ExternalContent\RenderArray\LinkBuilder: {}
  Drupal\niklan\Loader\ExternalContent\Blog: {}

  external_content.environment.blog:
    class: Drupal\external_content\Environment\Environment
    arguments:
      $configuration:
        file_finder:
          extensions: ['md']
          directories: ['%external_content.blog.working_dir%']
      $id: 'blog'
    calls:
      - [addExtension, ['@Drupal\external_content\Extension\FileFinderExtension']]
      - [addExtension, ['@Drupal\external_content\Extension\BasicHtmlExtension']]
      - [addIdentifier, ['@Drupal\niklan\Identifier\ExternalContent\FrontMatterIdentifier']]
      - [addSerializer, ['@Drupal\niklan\Serializer\ExternalContent\DrupalMediaSerializer']]
      - [addBuilder, ['@Drupal\niklan\Builder\ExternalContent\RenderArray\DrupalMedia']]
      - [addBuilder, ['@Drupal\niklan\Builder\ExternalContent\RenderArray\CodeBlock']]
      - [addBuilder, ['@Drupal\niklan\Builder\ExternalContent\RenderArray\Note']]
      - [addBuilder, ['@Drupal\niklan\Builder\ExternalContent\RenderArray\LinkBuilder']]
      - [addSerializer, ['@Drupal\niklan\Serializer\ExternalContent\NoteSerializer']]
      - [addLoader, ['@Drupal\niklan\Loader\ExternalContent\Blog']]
      - [setEventDispatcher, ['@event_dispatcher']]
    tags:
      - { name: external_content.environment, id: blog, label: 'Blog articles' }
